import numpy as np
from sklearn.ensemble import IsolationForest
from typing import List, Dict, Any

class AnomalyDetector:
    def __init__(self, contamination=0.05, random_state=42, n_estimators=200):
        self.model = IsolationForest(
            contamination=contamination,
            random_state=random_state,
            n_estimators=n_estimators
        )
        self.fitted = False

    def fit(self, vectors: np.ndarray):
        self.model.fit(vectors)
        self.fitted = True

    def score(self, vectors: np.ndarray) -> np.ndarray:
        if not self.fitted:
            raise ValueError("AnomalyDetector not fitted")
        # lower score => more abnormal. We'll invert to anomaly_score
        raw = self.model.decision_function(vectors)
        anomaly_score = -raw
        return anomaly_score
